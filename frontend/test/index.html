<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web Audio API Reverb Example</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 2rem; }
    input { margin: 0.5rem 0; }
    button { margin: 1rem 0; }
  </style>
</head>
<body>
  <h1>🔊 Web Audio API: Реверберация</h1>

  <label>🎵 Выберите аудиофайл:
    <input type="file" id="audioFile" accept="audio/*" />
  </label><br>

  <label>🌌 Выберите Impulse Response (IR):
    <input type="file" id="irFile" accept="audio/*" />
  </label><br>

  <label>🎚️ Dry/Wet:
    <input type="range" id="mix" min="0" max="1" step="0.01" value="0.5" />
  </label><br>

  <button id="playBtn">▶️ Воспроизвести</button>

  <p id="status"></p>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let trackSource;
    let convolver;
    let dryGain, wetGain;

    let audioBuffer, irBuffer;

    const audioInput = document.getElementById('audioFile');
    const irInput = document.getElementById('irFile');
    const mixInput = document.getElementById('mix');
    const playBtn = document.getElementById('playBtn');
    const status = document.getElementById('status');

    audioInput.addEventListener('change', async () => {
      const file = audioInput.files[0];
      if (file) {
        const arrayBuffer = await file.arrayBuffer();
        audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        status.textContent = `🎵 Загружено: ${file.name}`;
      }
    });

    irInput.addEventListener('change', async () => {
      const file = irInput.files[0];
      if (file) {
        const arrayBuffer = await file.arrayBuffer();
        irBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        status.textContent += ` | 🌌 IR: ${file.name}`;
      }
    });

    playBtn.addEventListener('click', () => {
      if (!audioBuffer) {
        alert("Сначала выбери аудиофайл!");
        return;
      }

      if (!irBuffer) {
        alert("Сначала выбери IR-файл!");
        return;
      }

      // Очищаем старый источник, если есть
      if (trackSource) {
        trackSource.stop();
      }

      trackSource = audioCtx.createBufferSource();
      trackSource.buffer = audioBuffer;

      convolver = audioCtx.createConvolver();
      convolver.buffer = irBuffer;

      dryGain = audioCtx.createGain();
      wetGain = audioCtx.createGain();

      dryGain.gain.value = 1 - mixInput.value;
      wetGain.gain.value = mixInput.value;

      trackSource.connect(dryGain);
      trackSource.connect(convolver);

      convolver.connect(wetGain);

      dryGain.connect(audioCtx.destination);
      wetGain.connect(audioCtx.destination);

      trackSource.start();

      status.textContent += ` | ▶️ Играет...`;
    });

    mixInput.addEventListener('input', () => {
      if (dryGain && wetGain) {
        dryGain.gain.value = 1 - mixInput.value;
        wetGain.gain.value = mixInput.value;
      }
    });
  </script>
</body>
</html>
